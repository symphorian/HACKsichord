<html>                                                                  
<head>
	<style>
    #freqcanvas {
			margin-left: auto;
      margin-right: auto;
      display: block;
      background-color: black;
    }
    #buttons {
    	text-align: center;
    }
	</style>

	<script type="text/javascript" src="Source/chroma.min.js"></script>
	<script type="text/javascript" src="Source/HACKsichordDefinitions.js"></script>
	<script type="text/javascript" src="Source/HACKsichordNotes.js"></script>
	<script type="text/javascript" src="Source/HACKsichordKeySignatures.js"></script>
	<script type="text/javascript" src="Source/HACKsichordInstrument.js"></script>
	<script type="text/javascript" src="Source/HACKsichordBuilder.js"></script>
	<script type="text/javascript">
		window.AudioContext = (function() {
		  return window.AudioContext || window.webkitAudioContext || window.mozAudioContext;
		})();

		// Hacks to deal with different function names in different browsers
		window.requestAnimFrame = (function(){
		  return window.requestAnimationFrame ||
		    window.webkitRequestAnimationFrame ||
		    window.mozRequestAnimationFrame ||
		    function(callback, element){
		      window.setTimeout(callback, 1000 / 60);
		    };
		})();

		// Global Variables for Audio
		var analyserNode;
		var javascriptNode;
		var dynamicsCompressorNode;
		var audioData = null;
		var sampleSize = 1024;  // number of samples to collect before analyzing data
		var fftSize = 1024;
		var frequencyArray;

		// Global Variables for the Graphics
		//var canvasWidth = 512; // TUTORIALS 1 & 2
		var canvasWidth  = 800; // TUTORIALS 3 & 4
		var canvasHeight = 256;
		var freqCanvas;
		var freqctx;
		var column = 0;

		// Uses the chroma.js library by Gregor Aisch to create a color gradient
    // download from https://github.com/gka/chroma.js
    var colorScale = new chroma.scale(['black', 'red', 'yellow', 'white']).out('hex');

		var audioContext;
		var instrument;

		window.onload = function() {
			try {
				audioContext = new AudioContext();
		  } catch(e) {
		    alert('Web Audio API is not supported in this browser');
		  }

			freqCanvas = document.getElementById('freqcanvas');
			freqctx = document.getElementById('freqcanvas').getContext("2d");

			// Set up the audio Analyser, the Source Buffer and javascriptNode
		  setupAudioNodes();

		  // setup the event handler that is triggered every time enough samples
		  // have been collected,
		  // trigger the audio analysis and draw the results
		  javascriptNode.onaudioprocess = function () {
		    // get the Frequency Domain data for this sample
        analyserNode.getByteFrequencyData(frequencyArray);

		    // draw the display if the audio is playing
		    requestAnimFrame(drawSpectrogram);
		  }

			instrument = new HSC.Instrument(audioContext);
		}

		function setupAudioNodes() {
		  analyserNode   = audioContext.createAnalyser();
		  analyserNode.smoothingTimeConstant = 0.0;
      analyserNode.fftSize = fftSize;

		  javascriptNode = audioContext.createScriptProcessor(sampleSize, 1, 1);

		  dynamicsCompressorNode = audioContext.createDynamicsCompressor();

		  // Create the array for the data values
    	frequencyArray = new Uint8Array(analyserNode.frequencyBinCount);    // **

      dynamicsCompressorNode.connect(analyserNode);
		  analyserNode.connect(javascriptNode);
		  javascriptNode.connect(audioContext.destination);
		}

		// Draw the Spectrogram from the frequency array
	  // The array has 512 elements - but truncate at 256
	  function drawSpectrogram() {
	    for (var i = 0; i < frequencyArray.length; i++) {
	      // if (frequencyArray[i] / 256.0 > 0.9) {
		      // Get the color from the color map, draw 1x1 pixel rectangle
		          freqctx.fillStyle = colorScale(frequencyArray[i] / 256.0);
		          freqctx.fillRect(column,canvasHeight - i, 1, 1);
		      //}
	    }

	    column++;
	    if (column > 800) {
	      column = 0;
	    }
	  }

		// function playRandomMeasures(timesToPlay) {
		// 	var randomScaleType = Math.floor(Math.random()*5);
		// 	var randomHalfStepNumber = Math.floor(Math.random()*40+36);

		// 	var scaleFrequencies = 
		// 	  constructScaleByScaleTypeAndHalfStepNumber(randomScaleType, randomHalfStepNumber);

		// 	for (var i = 0; i < timesToPlay; i++) {
		// 		playRandomMeasureWithScaleAtFutureTime(scaleFrequencies,i*4);
		// 	}
		// }

		// function playRandomMeasure() {
		// 	var randomScaleType = Math.floor(Math.random()*5);
		// 	var randomHalfStepNumber = Math.floor(Math.random()*40+36);

		// 	var scaleFrequencies = 
		// 	  constructScaleByScaleTypeAndHalfStepNumber(randomScaleType, randomHalfStepNumber);

		// 	playRandomMeasureWithScaleAtFutureTime(scaleFrequencies,0);
		// }

		// function playRandomMeasureWithScaleAtFutureTime(scaleFrequencies, futureBeats) {
		// 	playRandomMeasureWithBeatsPerMeasureTempoAndScaleAtBeatsInFuture2(
		// 		4,
		// 		80,
		// 		scaleFrequencies,
		// 		futureBeats
		//   );
		// }

		// function playRandomMeasureWithBeatsPerMeasureTempoAndScaleAtBeatsInFuture(
		// 	bpm,
		// 	tempo,
		// 	scaleFrequencies,
		// 	futureBeats
	 //  ) {
		// 	var eighthNoteLength = 0.5;
		// 	var eighthNoteTime = (60 / tempo) / 2;
		// 	var beatsRemaining = bpm;
		// 	var currentLength = 0;

		// 	while (beatsRemaining > 0) {
		// 		var noteLength = Math.ceil(Math.random()*beatsRemaining*2);
		// 		var noteIndex = Math.floor(Math.random()*scaleFrequencies.length);

		// 		playFrequencyAtFutureTimeForDuration(
		// 			scaleFrequencies[noteIndex], 
		// 			futureBeats*eighthNoteTime*2 + currentLength, 
		// 			eighthNoteTime*noteLength
		// 	  );

		// 		currentLength += eighthNoteTime*noteLength;
		// 		beatsRemaining -= eighthNoteLength*noteLength;
		// 	}
		// }

		// function playRandomMeasureWithBeatsPerMeasureTempoAndScaleAtBeatsInFuture2(
		// 	bpm,
		// 	tempo,
		// 	scaleFrequencies,
		// 	futureBeats
	 //  ) {
		// 	var sixteenthNoteLength = 0.25;
		// 	var sixteenthNoteTime = (60 / tempo) / 4;
		// 	var beatsRemaining = bpm;
		// 	var currentLength = 0;

		// 	while (beatsRemaining > 0) {
		// 		var possibleNoteLengths = [1,2,4,8,16,32];
		// 		var possibleNoteLengthsLessThanRemaining = new Array();
		// 		for (var i = 0; i < possibleNoteLengths.length; i++) {
		// 			if (possibleNoteLengths[i] <= beatsRemaining/sixteenthNoteLength) {
		// 				possibleNoteLengthsLessThanRemaining.push(possibleNoteLengths[i]);
		// 			}
		// 		}
		// 		var noteLength = possibleNoteLengthsLessThanRemaining[
		// 	    Math.floor(Math.random()*possibleNoteLengthsLessThanRemaining.length)
		// 	  ];
		// 		var noteIndex = Math.floor(Math.random()*scaleFrequencies.length);

		// 		playFrequencyAtFutureTimeForDuration(
		// 			scaleFrequencies[noteIndex], 
		// 			(futureBeats/sixteenthNoteLength)*sixteenthNoteTime + currentLength,
		// 			sixteenthNoteTime*noteLength
		// 	  );

		// 		var test = sixteenthNoteTime*noteLength;

		// 		if (test == NaN) {
		// 			console.log("16th * notelength:" + sixteenthNoteTime + notelength);
		// 		}

		// 		currentLength += sixteenthNoteTime*noteLength;
		// 		beatsRemaining -= sixteenthNoteLength*noteLength;
		// 	}
		// }

		function playCMajorScale() {
			var scaleType = HSC.ScaleType.MAJOR;
			var startingNote = HSC.getNoteByOctaveAndName(5, "C");
			var scale = HSC.buildScale(startingNote, scaleType, true);

			var cues = new Array();
			var noteLength = 0.5;
			for (var i = 0; i < scale.length; i++) {
				cues[i] = new HSC.Cue(noteLength, i*noteLength);
			}

			instrument.playNotesAtCues(scale, cues);
		}

		function playRandomCScale() {
			var scaleTypes = new Array(HSC.ScaleType.CHROMATIC, HSC.ScaleType.MAJOR, HSC.ScaleType.MINOR_NATURAL, HSC.ScaleType.MINOR_HARMONIC, HSC.ScaleType.MINOR_MELODIC);
			var randomScaleType = scaleTypes[Math.floor(Math.random()*scaleTypes.length)];
			var startingNote = HSC.getNoteByOctaveAndName(5, "C");
			var scale = HSC.buildScale(startingNote, randomScaleType, true);

			var cues = new Array();
			var noteLength = 0.5;
			for (var i = 0; i < scale.length; i++) {
				cues[i] = new HSC.Cue(noteLength, i*noteLength);
			}

			instrument.playNotesAtCues(scale, cues);
		}		

		function playDiatonicTriadsByOctaveAndName(octave, name) {
			var diatonicTriads = [
				HSC.DiatonicTriadType.I,
				HSC.DiatonicTriadType.ii,
				HSC.DiatonicTriadType.iii,
				HSC.DiatonicTriadType.IV,
				HSC.DiatonicTriadType.V,
				HSC.DiatonicTriadType.vi,
				HSC.DiatonicTriadType.viio,
				HSC.DiatonicTriadType.I,
			];
      var scaleType = HSC.ScaleType.MAJOR;
			var startingNote = HSC.getNoteByOctaveAndName(octave, name);
			var scale = HSC.buildScale(startingNote, scaleType, false);

			var chords = new Array();
			for (var i = 0; i < scale.length; i++) {
				chords[i] = HSC.buildDiatonicTriad(scale[i], diatonicTriads[i]);
			}

			var cues = new Array();
			var noteLength = 2;
			for (var i = 0; i < scale.length; i++) {
				instrument.playNotesAtCue(
					chords[i], 
					new HSC.Cue(noteLength, i*noteLength)
				);
			}
		}

		// function playScaleTypeByOctaveAndName(scaleType, octave, name) {
		// 	playScaleTypeByOctaveAndNameWithNoteDuration(scaleType, octave, name, 1);
		// }

		// function playScaleTypeByOctaveAndNameWithNoteDuration(
		// 	scaleType,
		// 	octave,
		// 	name,
		// 	noteDuration
	 //  ) {
		// 	var scaleFrequencies = 
		// 	  constructScaleByScaleTypeOctaveAndName(scaleType, octave, name);

		// 	playScaleWithNoteDuration(scaleFrequencies, noteDuration);
		// }

		// function playScaleTypeByHalfStepNumber(scaleType, halfStepNumber) {
		// 	playScaleTypeByHalfStepNumberWithNoteDuration(scaleType, halfStepNumber, 1);
		// }

		// function playScaleTypeByHalfStepNumberWithNoteDuration(
		// 	scaleType,
		// 	halfStepNumber,
		// 	noteDuration
		// ) {
		// 	var scaleFrequencies = 
		// 	  constructScaleByScaleTypeAndHalfStepNumber(scaleType, halfStepNumber);

		// 	playScaleWithNoteDuration(scaleFrequencies, noteDuration);
		// }

		// function playScaleWithNoteDuration(scaleFrequencies, noteDuration) {
		// 	var timeCounter = 0
		// 	for (var i = 0; i < scaleFrequencies.length; i++) {
		// 		playFrequencyAtFutureTimeForDuration(
		// 			scaleFrequencies[i],
		// 			timeCounter*noteDuration,
		// 			noteDuration
		// 		);
		// 		timeCounter++;
		// 	}

		// 	for (var i = scaleFrequencies.length - 2; i > -1; i--) {
		// 		playFrequencyAtFutureTimeForDuration(
		// 			scaleFrequencies[i],
		// 			timeCounter*noteDuration,
		// 			noteDuration
		// 		);
		// 		timeCounter++;
		// 	}
		// }

		

		// function constructScaleByScaleTypeOctaveAndName(scaleType, octave, name) {
		// 	var halfStepNumber = notesByOctaveAndName[octave][name].HalfStepNumber;

		// 	return constructScaleByScaleTypeAndHalfStepNumber(scaleType, halfStepNumber);
		// }

		// function constructScaleByScaleTypeAndHalfStepNumber(scaleType, halfStepNumber) {
		// 	var vHalfStepNumber = validateHalfStepNumber(halfStepNumber);
		// 	if (vHalfStepNumber == null) return [0,0,0,0,0,0,0];

		// 	var scaleTemplate = getScaleTemplateByScaleType(scaleType);
		// 	var scale = new Array();
		// 	var currentHalfStepNumber = vHalfStepNumber;
		// 	scale.push(getNoteFrequencyByHalfStepNumber(currentHalfStepNumber));

		// 	for (var i = 0; i < scaleTemplate.length; i++) {
		// 		currentHalfStepNumber += scaleTemplate[i];

		// 		if (validateHalfStepNumber(currentHalfStepNumber) == null) {
		// 			scale.push(0);
		// 		}
		// 		else {
		// 			scale.push(getNoteFrequencyByHalfStepNumber(currentHalfStepNumber));
		// 		}
		// 	}

		// 	return scale;
		// }

		// function getNoteFrequencyByOctaveAndName(octave, name) {
		// 	var vOctave = validateNoteOctave(octave);
		// 	if (vOctave == null) return 0;

		// 	//var vLetter = validateNoteLetter(octave,letter);
		// 	var vName = validateNoteName(octave, name);
		// 	if (vName == null) return 0;
			
		// 	//return noteFrequencyByOctaveAndLetter[octave][letter];
		// 	return notesByOctaveAndName[vOctave][vName].Frequency;

		// }

		// function validateNoteName(octave, letterAndSign) {
		// 	var normalName;
		// 	switch(letterAndSign) {
		// 		case 'C':
		// 		case 'C#':
		// 		case 'Db':
		// 		case 'D':
		// 		case 'D#':
		// 		case 'Eb':
		// 		case 'E':
		// 		case 'F':
		// 		case 'F#':
		// 		case 'Gb':
		// 		case 'G':
		// 		case 'G#':
		// 		case 'Ab':
		// 		case 'A':
		// 		case 'A#':
		// 		case 'Bb':
		// 		case 'B':
		// 			normalName = letterAndSign;
		// 			break;

		// 		case 'Cb':
		// 			normalName = 'B';
		// 			break;

		// 		case 'E#':
		// 			normalName = 'F';
		// 			break;

		// 		case 'Fb':
		// 			normalName = 'E';
		// 			break;

		// 		case 'B#':
		// 			normalName = 'C';
		// 			break;

		// 		case 'Cbb':
		// 			normalName = 'Bb';
		// 			break;

		// 		case 'C##':
		// 			normalName = 'D';
		// 			break;

		// 		case 'Dbb':
		// 			normalName = 'C';
		// 			break;

		// 		case 'D##':
		// 			normalName = 'E';
		// 			break;

		// 		case 'Ebb':
		// 			normalName = 'D';
		// 			break;

		// 		case 'E##':
		// 			normalName = 'F#';
		// 			break;

		// 		case 'Fbb':
		// 			normalName = 'Eb';
		// 			break;

		// 		case 'F##':
		// 			normalName = 'G';
		// 			break;

		// 		case 'Gbb':
		// 			normalName = 'F';
		// 			break;

		// 		case 'G##':
		// 			normalName = 'A';
		// 			break;

		// 		case 'Abb':
		// 			normalName = 'G';
		// 			break;

		// 		case 'A##':
		// 			normalName = 'B';
		// 			break;

		// 		case 'Bbb':
		// 			normalName = 'A';
		// 			break;

		// 		case 'B##':
		// 			normalName = 'C#';
		// 			break;

		// 		default:
		// 			break;
		// 	}

		// 	var validatedName;
		// 	if (notesByOctaveAndName[octave][normalName] != null) {
		// 		validatedName = normalName;
		// 	}

		// 	return validatedName;
		// }

		// function validateNoteOctave(octave) {
		// 	var validatedOctave;

		// 	if (notesByOctaveAndName[octave] != null) {
		// 		validatedOctave = octave;
		// 	}

		// 	return validatedOctave;
		// }

		// function validateHalfStepNumber(halfStepNumber) {
		// 	var validatedHalfStepNumber;

		// 	if (notesByHalfStepNumber[halfStepNumber] != null) {
		// 		validatedHalfStepNumber = halfStepNumber;
		// 	}

		// 	return validatedHalfStepNumber;
		// }

		function getObjectSize(obj) {
			var size = 0, key;
		    for (key in obj) {
		      if (obj.hasOwnProperty(key)) size++;
		    }
		    return size;
		}

	</script>

</head>

<body>
	<p id="buttons">
		<button onclick="playCMajorScale();">Play C Major Scale</button>
		<button onclick="playRandomCScale();">Play Random C Scale</button>
		<button onclick="playDiatonicTriadsByOctaveAndName(4, 'C');">
			Play Diatonic Triads in C
		</button>
	</p>
	<canvas id="freqcanvas" width="800" height="256" ></canvas>
</body>
</html>